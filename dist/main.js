(()=>{"use strict";function e(e,t){this._element=e,this._tools=t,this._id=null,this._shapes={},this._past=[],this._future=[],this._timestamp=0,this._buffer=[],this._background=null,this._scale=1,this._offset=[0,0],this._shapeUpdateCallback=this._shapePatchCallback=this._shapeRemoveCallback=this._shapeAddCallback=this._clearCallback=this._historyChangeCallback=()=>{}}function t(){return Math.floor(4294967296*(1+Math.random())).toString(16).substring(1)}function a(e,t,a){return e.fill("none").stroke({color:t,width:a,linecap:"round"})}e.prototype._tryNotify=function(e){let t=(new Date).getTime();t-this._timestamp<250||(e(),this._timestamp=t)},e.prototype._historyChange=function(){this._historyChangeCallback(this._past.length>0,this._future.length>0)},e.prototype._translate=function(e,t){return[this._offset[0]+e/this._scale,this._offset[1]+t/this._scale]},e.prototype.startShape=function(e,s,o,n,i){if(this._id)return;this._id=t(),[n,i]=this._translate(n,i);let h={kind:e,color:s,width:o,data:this._tools[e].start(n,i)};this._shapes[this._id]={view:a(this._tools[e].draw(this._element,h.data),s,o),model:h},this._future=[],this._past.push(this._id),this._historyChange(),this._shapeUpdateCallback(this._id,h)},e.prototype.drawShape=function(e,t){if(!this._id)return;[e,t]=this._translate(e,t);let a=this._shapes[this._id],s=this._tools[a.model.kind],o=s.move(e,t,a.model.data);s.update(a.view,a.model.data),o?(this._buffer=this._buffer.concat(o),this._tryNotify((()=>{this._shapePatchCallback(this._id,this._buffer),this._buffer=[]}))):this._tryNotify((()=>this._shapeUpdateCallback(this._id,a.model)))},e.prototype.endShape=function(){this._id&&(this._buffer.length>0?(this._shapePatchCallback(this._id,this._buffer),this._buffer=[]):this._shapeUpdateCallback(this._id,this._shapes[this._id].model),this._shapeAddCallback(this._id,this._shapes[this._id].model),this._id=null)},e.prototype.updateShape=function(e,t){this._shapes[e]?this._tools[t.kind].update(this._shapes[e].view,this._shapes[e].model.data=t.data):this._shapes[e]={view:a(this._tools[t.kind].draw(this._element,t.data),t.color,t.width),model:t}},e.prototype.patchShape=function(e,t){this._shapes[e]&&this._tools[this._shapes[e].model.kind].update(this._shapes[e].view,this._shapes[e].model.data=this._shapes[e].model.data.concat(t))},e.prototype.removeShape=function(e){this._shapes[e]&&(this._shapes[e].view.remove(),delete this._shapes[e])},e.prototype.clear=function(){this.removeAll(),this._clearCallback()},e.prototype.removeAll=function(){this._id=null,this._shapes={},this._past=[],this._future=[],this._timestamp=0,this._buffer=[],this._background=null,this._element.clear(),this._historyChange()},e.prototype.updateBackground=function(e){this._background&&this._background.remove(),this._background=this._element.image(e).back()},e.prototype.resizeViewbox=function(e,t){let a=this._element.viewbox();this._element.viewbox(a.x,a.y,e/this._scale,t/this._scale)},e.prototype.pan=function(e,t){let a=this._element.viewbox();this._offset=[a.x+e/this._scale,a.y+t/this._scale],this._element.viewbox(this._offset[0],this._offset[1],a.width,a.height)},e.prototype.zoom=function(e){this._scale*=e;let t=this._element.viewbox();this._element.viewbox(t.x,t.y,t.width/e,t.height/e)},e.prototype.undo=function(){let e=this._past.pop();e&&(this._future.push(this._shapes[e].model),this.removeShape(e),this._shapeRemoveCallback(e),this._historyChange())},e.prototype.redo=function(){let e=this._future.pop();if(!e)return;let a=t();this.updateShape(a,e),this._shapeUpdateCallback(a,e),this._shapeAddCallback(a,e),this._past.push(a),this._historyChange()},e.prototype.onShapeUpdate=function(e){this._shapeUpdateCallback=e},e.prototype.onShapeAdd=function(e){this._shapeAddCallback=e},e.prototype.onShapeRemove=function(e){this._shapeRemoveCallback=e},e.prototype.onShapePatch=function(e){this._shapePatchCallback=e},e.prototype.onClear=function(e){this._clearCallback=e},e.prototype.onHistoryChange=function(e){this._historyChangeCallback=e};const s=e;function o(e,t,a){this._urlFactory=e,this._protocol=t,this._reconnectInterval=a,this._webSocket=null,this.onopen=this.onclose=this.onmessage=null,this._connect()}o.prototype._connect=async function(){let e=await this._urlFactory(),t=this._webSocket=new WebSocket(e,this._protocol);t.onopen=()=>{console.log("WebSocket connected"),this.onopen&&this.onopen()},t.onclose=()=>{console.log("WebSocket disconnected"),this.onclose&&this.onclose(),this._reconnectInterval>0&&(console.log(`Reconnect in ${this._reconnectInterval} ms`),setTimeout((()=>this._connect()),this._reconnectInterval))},t.onmessage=e=>{this.onmessage&&this.onmessage(e)}},o.prototype.sendEvent=function(e){this._webSocket.send(JSON.stringify({type:"event",event:"message",dataType:"json",data:e}))},o.prototype.sendToGroup=function(e,t){this._webSocket.send(JSON.stringify({type:"sendToGroup",group:e,dataType:"json",data:t}))};const n=o;!async function(){let e={polyline:{start:(e,t)=>[e,t],move:(e,t,a)=>(a.push(e,t),[e,t]),draw:(e,t)=>e.polyline(t),update:(e,t)=>e.plot(t)},line:{start:(e,t)=>[e,t,e,t],move:(e,t,a)=>{a[2]=e,a[3]=t},draw:(e,t)=>e.line(t),update:(e,t)=>e.plot(t)},rect:{start:(e,t)=>[e,t,e,t],move:(e,t,a)=>{a[2]=e,a[3]=t},draw:(e,t)=>e.rect(Math.abs(t[2]-t[0]),Math.abs(t[3]-t[1])).move(Math.min(t[0],t[2]),Math.min(t[1],t[3])),update:(e,t)=>e.x(Math.min(t[2],t[0])).y(Math.min(t[1],t[3])).size(Math.abs(t[2]-t[0]),Math.abs(t[3]-t[1]))},circle:{start:(e,t)=>[e,t,0],move:(e,t,a)=>{a[2]=Math.floor(Math.sqrt((a[0]-e)*(a[0]-e)+(a[1]-t)*(a[1]-t)))},draw:(e,t)=>e.circle(2*t[2]).cx(t[0]).cy(t[1]),update:(e,t)=>e.cx(t[0]).cy(t[1]).radius(t[2])},ellipse:{start:(e,t)=>[e,t,e,t],move:(e,t,a)=>{a[2]=e,a[3]=t},draw:(e,t)=>e.ellipse(Math.abs(t[2]-t[0]),Math.abs(t[3]-t[1])).cx((t[0]+t[2])/2).cy((t[1]+t[3])/2),update:(e,t)=>e.cx((t[0]+t[2])/2).cy((t[1]+t[3])/2).radius(Math.abs(t[2]-t[0])/2,Math.abs(t[3]-t[1])/2)}},t=new s(SVG("whiteboard"),e),a=Math.random().toString(36).substr(2,8),o={connected:!1,totalUsers:1,hasUndo:!1,hasRedo:!1,tool:"polyline",color:"black",width:1,tools:Object.keys(e),colors:["black","grey","darkred","red","orange","yellow","green","deepskyblue","indigo","purple"],widths:[1,2,4,8],messages:[],messageColor:"black",name:"",draft:"",showLog:!0,maxImageSize:1920,diagram:t},i=new n((async function(){let e=await fetch("/negotiate");return(await e.json()).url}),"json.webpubsub.azure.v1",5e3);i.onopen=async()=>{o.connected=!0,t.removeAll();let e=await fetch("/diagram"),a=await e.json();for(let e in a.shapes)t.updateShape(e,a.shapes[e]);a.background&&t.updateBackground("/background/"+a.background)},i.onclose=()=>o.connected=!1,i.onmessage=e=>{let s=JSON.parse(e.data);if("message"!==s.type)return;let n=s.data;if("group"===s.from&&"draw"===s.group)switch(n.name){case"clear":{let e=n.data;a!==e&&t.removeAll();break}case"updateShape":{let[e,s,o]=n.data;a!==e&&t.updateShape(s,o);break}case"patchShape":{let[e,s,o]=n.data;a!==e&&t.patchShape(s,o);break}case"removeShape":{let[e,s]=n.data;a!==e&&t.removeShape(s);break}case"newMessage":{let[e,t,s]=n.data;a!==e&&o.messages.push({name:t,message:s});break}case"updateUser":{let e=n.data;o.totalUsers=e;break}}else if("server"===s.from)switch(n.name){case"updateBackground":{let e=n.data;t.updateBackground("/background/"+e);break}}},t.onShapeUpdate(((e,t)=>i.sendToGroup("draw",{name:"updateShape",data:[a,e,t]}))),t.onShapePatch(((e,t)=>i.sendToGroup("draw",{name:"patchShape",data:[a,e,t]}))),t.onShapeAdd(((e,t)=>i.sendEvent({name:"addShape",data:[e,t]}))),t.onShapeRemove((e=>{i.sendEvent({name:"removeShape",data:e}),i.sendToGroup("draw",{name:"removeShape",data:[a,e]})})),t.onClear((()=>{i.sendEvent({name:"clear"}),i.sendToGroup("draw",{name:"clear",data:a})})),t.onHistoryChange(((e,t)=>[o.hasUndo,o.hasRedo]=[e,t])),new Vue({el:"#app",data:o,methods:{upload:async function(){let e=await(a=event.target.files[0],s=this.maxImageSize,new Promise((e=>{if(!s)return void e(!1);let t=new FileReader;t.onload=t=>{let a=new Image;a.onload=function(t){let o=document.createElement("canvas"),n=Math.max(a.width/s,a.height/s);n<1?e(!1):(o.width=a.width/n,o.height=a.height/n,o.getContext("2d").drawImage(a,0,0,o.width,o.height),e((e=>{let t=";base64,";if(-1==e.indexOf(t)){let t=e.split(","),a=t[0].split(":")[1],s=t[1];return new Blob([s],{type:a})}let a=e.split(t),s=a[0].split(":")[1],o=window.atob(a[1]),n=o.length,i=new Uint8Array(n);for(let e=0;e<n;++e)i[e]=o.charCodeAt(e);return new Blob([i],{type:s})})(o.toDataURL("image/jpeg"))))},a.src=t.target.result},t.readAsDataURL(a)}))),t=new FormData($("#uploadForm")[0]);var a,s;e&&(t.delete("file"),t.append("file",e)),await fetch("/background/upload",{method:"POST",body:t}),$("#uploadForm")[0].reset()},zoomIn:()=>t.zoom(1.25),zoomOut:()=>t.zoom(.8),sendMessage:function(){this.draft&&(this.messages.push({name:this.name,message:this.draft}),i.sendToGroup("draw",{name:"newMessage",data:[a,this.name,this.draft]}),this.draft="")},setName:function(){this.name&&$("#inputName").modal("toggle")},toggleLog:function(){this.showLog=!this.showLog},showSettings:()=>$("#settings").modal({backdrop:"static",keyboard:!1})}});let h,l,r,d={panAndZoom:{startOne:e=>0,moveOne:(e,a)=>t.pan(a[0]-e[0],a[1]-e[1]),startTwo:(e,t)=>0,moveTwo:(e,a,s,o)=>{let n=Math.sqrt(((a[0]-e[0])*(a[0]-e[0])+(a[1]-e[1])*(a[1]-e[1]))/((o[0]-s[0])*(o[0]-s[0])+(o[1]-s[1])*(o[1]-s[1])));t.pan(s[0]-e[0]/n,s[1]-e[1]/n),t.zoom(n)},end:()=>0},draw:{startOne:e=>{o.connected&&t.startShape(o.tool,o.color,o.width,e[0],e[1])},moveOne:(e,a)=>{o.connected&&t.drawShape(e[0],e[1])},startTwo:()=>0,moveTwo:()=>0,end:()=>{o.connected&&t.endShape()}}},p=e=>{h&&(l=e)},c=e=>{h&&l.length===e.length&&(!r&&1===e.length&&Math.abs(e[0][0]-l[0][0])<5&&Math.abs(e[0][1]-l[0][1])<5||(r=!0,1===e.length?d[h].startOne(l[0]):2===e.length&&d[h].startTwo(l[0],l[1]),1===e.length?d[h].moveOne(e[0],l[0]):2===e.length&&d[h].moveTwo(e[0],e[1],l[0],l[1]),l=e))},u=e=>{h&&(r&&d[h].end(),l=r=null)},_=(e,t)=>{let a=[];for(let s=0;s<e.length;s++)a.push(t(e[s]));return a};$("#whiteboard").on("mousedown",(e=>{h=e.ctrlKey?"panAndZoom":"draw",p([[e.offsetX,e.offsetY]])})).on("mousemove",(e=>{c([[e.offsetX,e.offsetY]])})).on("mouseup",(e=>{u(),h=null})).on("touchstart",(e=>{e.touches.length>2||(l&&u(),h=1===e.touches.length?"draw":"panAndZoom",p(_(e.touches,(e=>[e.pageX,e.pageY-66]))),e.preventDefault())})).on("touchmove",(e=>{c(_(e.touches,(e=>[e.pageX,e.pageY-66]))),e.preventDefault()})).on("touchend",(e=>{u(),h=null,e.preventDefault()})).on("touchcancel",(e=>{u(),h=null,e.preventDefault()})),$("#inputName").on("shown.bs.modal",(()=>{$("#username").focus()})).modal({backdrop:"static",keyboard:!1});let m=window.innerWidth;t.zoom(m<576?1/3:m<768?.5:m<992?2/3:m<1200?5/6:1),window.onresize=()=>t.resizeViewbox($("#whiteboard").width(),$("#whiteboard").height())}()})();